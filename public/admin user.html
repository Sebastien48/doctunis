<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Gestion des utilisateurs</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen">

    <!-- Barre de navigation -->
    <nav class="bg-gray-800 text-white">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            <h1 class="text-2xl font-bold">Administrateur</h1>
            <ul class="flex space-x-4">
                <li>
                    <a href="admin.html" class="hover:underline  text-xl text-red-800">Utilisateurs</a>
                </li>
                <li>
                    <a href="admin jury.html " class="hover:underline hover:underline  text-xl">Membres du Jury</a>
                </li>
                <li>
                    <a href="admin notes.html" class="hover:underline  text-xl">Notes</a>
                </li>
                <li>
                    <a href="adminplanning.html" class="hover:underline  text-xl">Planning</a>
                </li>
            </ul>
        </div>
    </nav>

    <div class="container mx-auto py-10 px-4">
        <h1 class="text-3xl font-bold bg-gray-600 text-white mb-8 text-center py-2">Gestion des Utilisateurs</h1>

        <!-- Message d'état -->
        <div id="status-message" class="mb-4 hidden">
            <div class="p-4 rounded"></div>
        </div>

        <div class="overflow-x-auto bg-white shadow-md rounded-lg">
            <!-- Loading spinner -->
            <div id="loading" class="text-center py-4">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-gray-900 mx-auto"></div>
            </div>

            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xl font-medium text-gray-500 uppercase">ID</th>
                        <th class="px-6 py-3 text-left text-xl font-medium text-gray-500 uppercase">Nom</th>
                        <th class="px-6 py-3 text-left text-xl font-medium text-gray-500 uppercase">Prénom</th>
                        <th class="px-6 py-3 text-left text-xl font-medium text-gray-500 uppercase">Email</th>
                        <th class="px-6 py-3 text-left text-xl font-medium text-gray-500 uppercase">Username</th>
                        <th class="px-6 py-3 text-left text-xl font-medium text-gray-500 uppercase">Rôle</th>
                        <th class="px-6 py-3 text-left text-xl font-medium text-gray-500 uppercase">Actions</th>
                    </tr>
                </thead>
                <tbody id="users-table" class="bg-white divide-y divide-gray-200">
                    <!-- Les utilisateurs seront insérés ici -->
                </tbody>
            </table>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const usersTableBody = document.getElementById('users-table');
            const loadingElement = document.getElementById('loading');
            const statusMessage = document.getElementById('status-message');

            function showLoading() {
                loadingElement.style.display = 'block';
                usersTableBody.style.display = 'none';
            }

            function hideLoading() {
                loadingElement.style.display = 'none';
                usersTableBody.style.display = 'table-row-group';
            }

            function showMessage(message, isError = false) {
                statusMessage.classList.remove('hidden');
                const messageDiv = statusMessage.querySelector('div');
                messageDiv.className = `p-4 rounded ${isError ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}`;
                messageDiv.textContent = message;
                
                setTimeout(() => {
                    statusMessage.classList.add('hidden');
                }, 3000);
            }

            async function fetchUsers() {
                showLoading();
                
                try {
                    const response = await fetch('/admin/users', {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        credentials: 'same-origin' // Important pour les sessions
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const users = await response.json();
                    
                    if (!Array.isArray(users)) {
                        throw new Error('Les données reçues ne sont pas un tableau');
                    }

                    usersTableBody.innerHTML = ''; // Vider le tableau existant
                    
                    users.forEach(user => {
                        const row = document.createElement('tr');
                        row.className = 'hover:bg-gray-50';
                        row.innerHTML = `
                            <td class="px-6 py-4 whitespace-nowrap">${user.id}</td>
                            <td class="px-6 py-4 whitespace-nowrap">${user.nom}</td>
                            <td class="px-6 py-4 whitespace-nowrap">${user.prenom}</td>
                            <td class="px-6 py-4 whitespace-nowrap">${user.email}</td>
                            <td class="px-6 py-4 whitespace-nowrap">${user.username}</td>
                            <td class="px-6 py-4 whitespace-nowrap">${user.role}</td>
                            <td class="px-6 py-4 whitespace-nowrap space-x-2">
                                <button class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded edit-btn" 
                                        data-id="${user.id}">
                                    Modifier
                                </button>
                                <button class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded delete-btn" 
                                        data-id="${user.id}">
                                    Supprimer
                                </button>
                            </td>
                        `;
                        usersTableBody.appendChild(row);
                    });

                    document.querySelectorAll('.delete-btn').forEach(button => {
                        button.addEventListener('click', async (e) => {
                            const userId = e.target.dataset.id;
                            if (confirm('Êtes-vous sûr de vouloir supprimer cet utilisateur ?')) {
                                try {
                                    const response = await fetch(`/admin/users/${userId}`, {
                                        method: 'DELETE',
                                        credentials: 'same-origin'
                                    });

                                    if (!response.ok) throw new Error('Erreur lors de la suppression');
                                    
                                    showMessage('Utilisateur supprimé avec succès');
                                    await fetchUsers(); // Recharger la liste
                                } catch (error) {
                                    showMessage('Erreur lors de la suppression', true);
                                    console.error('Erreur:', error);
                                }
                            }
                        });
                    });

                } catch (error) {
                    console.error('Erreur lors de la récupération des utilisateurs:', error);
                    showMessage('Erreur lors du chargement des utilisateurs', true);
                } finally {
                    hideLoading();
                }
            }

            // Charger les utilisateurs au démarrage
            fetchUsers();
        });
    </script>
</body>
</html>
